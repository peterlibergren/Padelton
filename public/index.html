<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <title>Padel Scoreboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: system-ui, sans-serif;
      background: #020617;
      color: #e5e7eb;
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at top, #1d283a 0, #020617 55%);
    }

    header {
      text-align: center;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }

    h1 {
      margin: 0;
      font-size: clamp(1.8rem, 3vw, 2.4rem);
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    /* Stilling-linje under logoet */
    .team-standing {
      margin-top: 6px;
      font-size: clamp(1.4rem, 3.2vw, 2rem);
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .team-standing span {
      display: inline-block;
      min-width: 1.6em;
      text-align: center;
    }

    #standingHome {
      color: #22c55e;
      font-weight: 800;
    }

    #standingAway {
      color: #ef4444;
      font-weight: 800;
    }

    .team-standing-label {
      opacity: 0.8;
      margin-right: 4px;
    }

    .hidden {
      display: none !important;
    }

    main {
      flex: 1;
      padding: 10px;
      box-sizing: border-box;
    }

    .courts-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 900px;
      margin: 0 auto 16px;
    }

    .court-card {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 16px;
      padding: 10px 12px;
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.3);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .court-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .court-title {
      font-size: clamp(1rem, 2.1vw, 1.2rem);
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .court-status-tag {
      font-size: 0.7rem;
      text-transform: uppercase;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      white-space: nowrap;
    }

    .court-status-tag.error {
      border-color: #f97373;
      color: #fecaca;
    }

    /* Teams-blok */
    .teams {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .team {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .team-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      font-weight: 600;
    }

    .team-home .team-label {
      color: #22c55e;
    }

    .team-away .team-label {
      color: #ef4444;
    }

    /* Vindende hold highlight */
    .team-winner {
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.9);
      border-radius: 12px;
    }

    /* 5-kolonne layout: Navn | SÃ¦t1 | SÃ¦t2 | Point | Partier */
    .score-row {
      display: grid;
      grid-template-columns: minmax(0, 3fr) repeat(4, minmax(0, 1fr));
      gap: 4px;
      align-items: stretch;
      font-size: clamp(1.2rem, 3.2vw, 1.6rem);
    }

    .score-cell {
      padding: 6px 8px;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .score-cell-name {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      text-align: left;
      overflow: hidden;
    }

    .player-name,
    .player-sub {
      font-size: clamp(1rem, 2.2vw, 1.1rem);
      line-height: 1.2;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      color: #e5e7eb;
      text-align: left;
    }

    .player-sub {
      opacity: 0.9;
    }

    .score-set {
      font-weight: 600;
      background: rgba(15, 23, 42, 0.9);
    }

    .set-winner {
      background: rgba(75, 85, 99, 0.95);
      border-color: rgba(156, 163, 175, 0.95);
      color: #f9fafb;
    }

    .score-points {
      background: #facc15;
      color: #111827;
      font-weight: 700;
      font-size: 1.2em;
    }

    .score-games {
      font-weight: 700;
      background: rgba(30, 64, 175, 0.9);
      border-color: rgba(129, 140, 248, 0.8);
    }

    .court-footer {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      font-size: 0.72rem;
      color: #cbd5f5;
      opacity: 0.85;
      flex-wrap: wrap;
      gap: 4px;
      border-top: 1px dashed rgba(148, 163, 184, 0.4);
      padding-top: 4px;
      margin-top: 2px;
    }

    .sets-summary,
    .match-format {
      margin-left: 8px;
      opacity: 0.85;
      font-size: 0.7rem;
      white-space: nowrap;
    }

    .info-card {
      max-width: 900px;
      margin: 0 auto 24px;
      font-size: 0.8rem;
      color: #9ca3af;
      text-align: center;
      opacity: 0.85;
    }

    .lunar-badge,
    .super-badge {
      display: inline-block;
      margin-left: 6px;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .lunar-badge {
      background: rgba(56, 189, 248, 0.12);
      border: 1px solid rgba(56, 189, 248, 0.6);
      color: #e0f2fe;
    }

    .super-badge {
      background: rgba(234, 179, 8, 0.18);
      border: 1px solid rgba(234, 179, 8, 0.8);
      color: #fef9c3;
    }

    /* --- LUNAR SLUTSKÃ†RM --- */

    .lunar-summary {
      max-width: 1400px;              /* bredere container */
      width: 95vw;
      margin: 16px auto 24px;
      padding: 16px 14px 18px;
      border-radius: 18px;
      background: rgba(15, 23, 42, 0.97);
      border: 1px solid rgba(148, 163, 184, 0.7);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
    }

    .lunar-summary-title {
      margin: 0 0 10px;
      font-size: clamp(1.6rem, 3vw, 2rem);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      text-align: center;
    }

    .lunar-summary-subtitle {
      margin: 0 0 14px;
      font-size: 0.9rem;
      text-align: center;
      color: #9ca3af;
      opacity: 0.9;
    }

    .summary-section {
      margin: 20px auto 8px;
      width: 100%;
    }

    .summary-round-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 8px;
      text-align: left;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .summary-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto; /* lad browseren fordele bredden pÃ¦nt */
    }

    .summary-table th,
    .summary-table td {
      padding: 8px 6px;
      border-bottom: 1px solid #4b5563;
      font-size: 0.95rem;
    }

    .summary-header-row th {
      background: #111827;
      border-bottom: 2px solid #6b7280;
      font-weight: 600;
      opacity: 0.95;
      text-align: center;
      white-space: nowrap;
    }

    /* kolonnejusteringer */
    .summary-table th:nth-child(1),
    .summary-table td:nth-child(1) {
      text-align: left;
      width: 10%;    /* Bane/Kamp */
    }

    .summary-table th:nth-child(2),
    .summary-table td:nth-child(2),
    .summary-table th:nth-child(3),
    .summary-table td:nth-child(3) {
      text-align: left;
      width: 25%;    /* Hjemme / Ude */
    }

    .summary-table th:nth-child(4),
    .summary-table td:nth-child(4),
    .summary-table th:nth-child(5),
    .summary-table td:nth-child(5),
    .summary-table th:nth-child(6),
    .summary-table td:nth-child(6),
    .summary-table th:nth-child(7),
    .summary-table td:nth-child(7) {
      text-align: center;
      width: 10%;    /* SÃ¦t og vinder */
    }

    .summary-table tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.9);
    }

    .summary-table tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.7);
    }

    .summary-player-main {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .summary-player-sub {
      font-size: 0.8rem;
      opacity: 0.85;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

  </style>
</head>
<body>
  <header>
    <h1>PADELTON</h1>
    <div id="teamStanding" class="team-standing hidden">
      <span class="team-standing-label">Stilling:</span>
      <span id="standingHome">0</span>
      <span>-</span>
      <span id="standingAway">0</span>
    </div>
  </header>

  <main>
    <section class="courts-list" id="courtsList"></section>

    <!-- LUNAR slutskÃ¦rm -->
    <section id="lunarSummary" class="lunar-summary hidden">
      <h2 class="lunar-summary-title">LUNAR â€“ Slutresultat</h2>
      <p class="lunar-summary-subtitle">
        Resultater fra LUNAR runde 1, runde 2 og evt. 7. kamp.
      </p>
      <div id="lunarSummaryContent"></div>
    </section>

    <div class="info-card">
      Live scoreboard â€¢ Opdateres automatisk hvert sekund
    </div>
  </main>

  <script>
    const BASE_URL = "";

    // Tjek om vi skal tvinge slutskÃ¦rm via URL: ?summary=1
const urlParams = new URLSearchParams(window.location.search);
const forceSummary = urlParams.get("summary") === "1";

    const courts = [
      { id: 1, sponsor: "Bane 1 â€“ BetaPack" },
      { id: 2, sponsor: "Bane 2 â€“ Brdr. Thybo" },
      { id: 3, sponsor: "Bane 3 â€“ Schantz" },
      { id: 4, sponsor: "Bane 4 â€“ 10-4" },
      { id: 5, sponsor: "Bane 5 â€“ Slagteren" },
    ];

    const list = document.getElementById("courtsList");
    
    // Gem sidste state og lÃ¥st slutscore pr. bane
    const lastStates = {};
    const lockedScore = {};
    
    // Opret kort DOM for hver bane
    courts.forEach(court => {
      const card = document.createElement("article");
      card.className = "court-card";
      card.id = `court-${court.id}`;

      card.innerHTML = `
        <div class="court-header">
          <div class="court-title">
            ${court.sponsor}
            <span class="lunar-badge hidden" id="lunarBadge-${court.id}">LUNAR</span>
            <span class="super-badge hidden" id="superBadge-${court.id}">SUPER MATCH-TIE</span>
          </div>
          <span class="court-status-tag" id="status-${court.id}">Opdatererâ€¦</span>
        </div>

        <div class="teams">
          <!-- Hjemmehold -->
          <div class="team team-home">
            <div class="team-label">Hjemme</div>
            <div class="score-row">
              <div class="score-cell score-cell-name">
                <span class="player-name" id="homeName1-${court.id}">Hjemme 1</span>
                <span class="player-sub"  id="homeName2-${court.id}"></span>
              </div>
              <div class="score-cell score-set" id="homeSet1-${court.id}">â€“</div>
              <div class="score-cell score-set" id="homeSet2-${court.id}">â€“</div>
              <div class="score-cell score-points" id="homePoints-${court.id}">â€“</div>
              <div class="score-cell score-games"  id="homeGames-${court.id}">â€“</div>
            </div>
          </div>

          <!-- Udehold -->
          <div class="team team-away">
            <div class="team-label">Ude</div>
            <div class="score-row">
              <div class="score-cell score-cell-name">
                <span class="player-name" id="awayName1-${court.id}">Ude 1</span>
                <span class="player-sub"  id="awayName2-${court.id}"></span>
              </div>
              <div class="score-cell score-set" id="awaySet1-${court.id}">â€“</div>
              <div class="score-cell score-set" id="awaySet2-${court.id}">â€“</div>
              <div class="score-cell score-points" id="awayPoints-${court.id}">â€“</div>
              <div class="score-cell score-games"  id="awayGames-${court.id}">â€“</div>
            </div>
          </div>
        </div>

        <div class="court-footer">
          <span>Sidst opdateret: <span id="updated-${court.id}">â€“</span></span>
          <span class="sets-summary" id="setsSummary-${court.id}"></span>
          <span class="match-format" id="format-${court.id}"></span>
        </div>
      `;

      list.appendChild(card);
    });

    // Parser en samlet set-streng, fx "6-4,5-7,7-6(4)"
// og returnerer et array med op til 3 objekter:
// [{ home: "6", away: "4" }, { home: "5", away: "7" }, { home: "7", away: "6(4)" }]

    
    // HjÃ¦lper: byg sÃ¦tscore-strenge (fx "7(4)" for taber i TB)
    function buildSetStrings(c, setIndex) {
      const homeKey = setIndex === 1 ? "set1Home" : "set2Home";
      const awayKey = setIndex === 1 ? "set1Away" : "set2Away";
      const tbKey   = setIndex === 1 ? "set1LoserTbPoints" : "set2LoserTbPoints";
      const lhKey   = setIndex === 1 ? "set1LoserIsHome"   : "set2LoserIsHome";

      const h = c[homeKey];
      const a = c[awayKey];

      if (h == null || a == null || h < 0 || a < 0) {
        return { home: "â€“", away: "â€“" };
      }

      const tb = c[tbKey];
      const lIsHome = !!c[lhKey];

      if (tb == null || tb < 0) {
        return { home: String(h), away: String(a) };
      }

      if (lIsHome) {
        return { home: `${h}(${tb})`, away: String(a) };
      } else {
        return { home: String(h), away: `${a}(${tb})` };
      }
    }

    // LUNAR-stilling Ã¸verst â€“ bruger globale totals fra adminState
    function updateTeamStanding(lunarEnabled, lunarCourts, lunarHomeTotal, lunarAwayTotal) {
      const standingEl = document.getElementById("teamStanding");
      const homeSpan = document.getElementById("standingHome");
      const awaySpan = document.getElementById("standingAway");

      if (!standingEl || !homeSpan || !awaySpan) return;

      const active =
        !!lunarEnabled &&
        Array.isArray(lunarCourts) &&
        lunarCourts.length > 0;

      if (!active) {
        standingEl.classList.add("hidden");
        homeSpan.textContent = "0";
        awaySpan.textContent = "0";
        return;
      }

      const h = Number.isFinite(Number(lunarHomeTotal)) ? Number(lunarHomeTotal) : 0;
      const a = Number.isFinite(Number(lunarAwayTotal)) ? Number(lunarAwayTotal) : 0;

      homeSpan.textContent = String(h);
      awaySpan.textContent = String(a);
      standingEl.classList.remove("hidden");
    }

function parseSetsStr(setsStr) {
  if (!setsStr || typeof setsStr !== "string") return [];

  // HjÃ¦lper: split et enkelt sÃ¦t-token i "home" og "away",
  // men IGNORER bindestreger inde i parenteser, fx:
  // "7-6(4)"     â†’ ["7", "6(4)"]
  // "6-6(2-7)"   â†’ ["6", "6(2-7)"]
  function splitSetToken(part) {
    let depth = 0;
    for (let i = 0; i < part.length; i++) {
      const ch = part[i];
      if (ch === "(") {
        depth++;
      } else if (ch === ")") {
        if (depth > 0) depth--;
      } else if (ch === "-" && depth === 0) {
        // fÃ¸rste "-" UDENFOR parenteser â†’ skiller hjem/ude
        const left  = part.slice(0, i).trim();
        const right = part.slice(i + 1).trim();
        return [left, right];
      }
    }
    // fandt ingen "-" udenfor parenteser â†’ hele strengen som "home"
    return [part.trim(), ""];
  }

  return setsStr
    .split(/[;,]/)        // sÃ¦t adskilt af komma/semikolon
    .map(s => s.trim())
    .filter(Boolean)
    .map(part => {
      const [homeRaw, awayRaw] = splitSetToken(part);
      return {
        home: homeRaw || "",
        away: awayRaw || "",
      };
    })
    .slice(0, 3);         // max 3 sÃ¦t
}


// HjÃ¦lper: byg sÃ¦tscore ud fra resultatobjektet (kombinerer felter + setsStr)
function getSetDisplayFromResult(m, setIndex) {
  // FÃ¸rst forsÃ¸g: brug de per-sÃ¦t-felter, hvis de giver mening
  const homeKey = setIndex === 1 ? "set1Home" : setIndex === 2 ? "set2Home" : null;
  const awayKey = setIndex === 1 ? "set1Away" : setIndex === 2 ? "set2Away" : null;
  const tbKey   = setIndex === 1 ? "set1LoserTbPoints" : setIndex === 2 ? "set2LoserTbPoints" : null;
  const lhKey   = setIndex === 1 ? "set1LoserIsHome"   : setIndex === 2 ? "set2LoserIsHome"   : null;

  if (homeKey && awayKey) {
    const h = m[homeKey];
    const a = m[awayKey];

    if (typeof h === "number" && typeof a === "number" && h >= 0 && a >= 0) {
      const tb = tbKey ? m[tbKey] : null;
      const lIsHome = lhKey ? !!m[lhKey] : false;

      if (tb == null || tb < 0) {
        return { home: String(h), away: String(a) };
      }

      if (lIsHome) {
        return { home: `${h}(${tb})`, away: String(a) };
      } else {
        return { home: String(h), away: `${a}(${tb})` };
      }
    }
  }

  // Fallback: parse setsStr (fx "6-4,5-7,7-6(4)")
  const parsed = parseSetsStr(m.setsStr || "");
  const idx = setIndex - 1;
  if (parsed[idx]) {
    return {
      home: parsed[idx].home || "",
      away: parsed[idx].away || "",
    };
  }

  return { home: "", away: "" };
}

function formatSetCell(setObj) {
  if (!setObj) return "";
  const h = (setObj.home || "").trim();
  const a = (setObj.away || "").trim();

  if (h && a) return `${h}-${a}`;
  if (h) return h;
  if (a) return a;
  return "";
}
    
// SlutskÃ¦rm â€“ oversigt over alle LUNAR-kampe
function renderLunarSummary(lunarResults) {
  const container = document.getElementById("lunarSummaryContent");
  if (!container) return;
  console.log("ðŸ” lunarResults til slutsiden:", lunarResults);
  container.innerHTML = "";

  if (!Array.isArray(lunarResults) || lunarResults.length === 0) {
    container.textContent = "Ingen LUNAR-resultater.";
    return;
  }

  // Sorter efter runde (1,2,7) og bane
  const sorted = [...lunarResults].sort((a, b) => {
    const ra = Number(a.round ?? 0);
    const rb = Number(b.round ?? 0);
    if (ra !== rb) return ra - rb;
    const ca = Number(a.courtId ?? 0);
    const cb = Number(b.courtId ?? 0);
    return ca - cb;
  });

  // Del op i runder
  const groups = { 1: [], 2: [], 7: [] };
  sorted.forEach(m => {
    const r = Number(m.round);
    if (r === 1 || r === 2 || r === 7) {
      groups[r].push(m);
    }
  });

  [1, 2, 7].forEach(r => {
    const list = groups[r];
    if (!list || list.length === 0) return;

    const section = document.createElement("section");
    section.className = "summary-section";

    const h = document.createElement("h3");
    h.className = "summary-round-title";
    if (r === 1) h.textContent = "Lunar runde 1";
    else if (r === 2) h.textContent = "Lunar runde 2";
    else h.textContent = "7. kamp â€“ SUPER MATCH-TIE";
    section.appendChild(h);

    // Tabel med Ã©n rÃ¦kke pr. kamp
    const table = document.createElement("table");
    table.className = "summary-table";

    const thead = document.createElement("thead");
    const headerRow = document.createElement("tr");
    headerRow.className = "summary-header-row";

    const thKamp = document.createElement("th");
    thKamp.textContent = "Kamp";
    headerRow.appendChild(thKamp);

    const thHome = document.createElement("th");
    thHome.textContent = "Hjemme";
    headerRow.appendChild(thHome);

    const thAway = document.createElement("th");
    thAway.textContent = "Ude";
    headerRow.appendChild(thAway);

    const thS1 = document.createElement("th");
    thS1.textContent = "1. sÃ¦t";
    headerRow.appendChild(thS1);

    const thS2 = document.createElement("th");
    thS2.textContent = "2. sÃ¦t";
    headerRow.appendChild(thS2);

    const thS3 = document.createElement("th");
    thS3.textContent = "3. sÃ¦t";
    headerRow.appendChild(thS3);

    const thWinner = document.createElement("th");
    thWinner.textContent = "Vinder";
    headerRow.appendChild(thWinner);

    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    list.forEach((m, idx) => {
      const tr = document.createElement("tr");

      const tdKamp = document.createElement("td");
      tdKamp.textContent = `Bane ${m.courtId ?? "?"}`;
      tr.appendChild(tdKamp);

      const tdHome = document.createElement("td");
      tdHome.textContent = m.homeName || "Hjemme";
      tr.appendChild(tdHome);

      const tdAway = document.createElement("td");
      tdAway.textContent = m.awayName || "Ude";
      tr.appendChild(tdAway);

      const s1 = getSetDisplayFromResult(m, 1);
      const s2 = getSetDisplayFromResult(m, 2);
      const s3 = getSetDisplayFromResult(m, 3);

      const tdS1 = document.createElement("td");
tdS1.textContent = formatSetCell(s1);
tr.appendChild(tdS1);

const tdS2 = document.createElement("td");
tdS2.textContent = formatSetCell(s2);
tr.appendChild(tdS2);

const tdS3 = document.createElement("td");
tdS3.textContent = formatSetCell(s3);
tr.appendChild(tdS3);

      const tdWinner = document.createElement("td");
      const w = Number(m.winner || 0);
      if (w === 1) tdWinner.textContent = "Hjemme";
      else if (w === 2) tdWinner.textContent = "Ude";
      else tdWinner.textContent = "";
      tr.appendChild(tdWinner);

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    section.appendChild(table);
    container.appendChild(section);
  });
}

    // Hent adminState + ALLE baner og opdater UI
    async function updateAllCourts() {
      try {
        const [adminResp, courtsResp] = await Promise.all([
          fetch(BASE_URL + "/api/adminState", { cache: "no-store" }),
          fetch(BASE_URL + "/api/courts", { cache: "no-store" }),
        ]);

        if (!adminResp.ok) throw new Error("HTTP adminState " + adminResp.status);
        if (!courtsResp.ok) throw new Error("HTTP courts " + courtsResp.status);

        const adminState = await adminResp.json();
        const data = await courtsResp.json();

        let lunarEnabled = false;
        let lunarCourts = [];

        try {
          lunarEnabled = !!adminState.lunarEnabled;
          lunarCourts = Array.isArray(adminState.lunarCourts)
            ? adminState.lunarCourts.map(Number).filter(n => Number.isFinite(n))
            : [];
        } catch (e) {
          console.warn("Kunne ikke lÃ¦se LUNAR-felter fra adminState:", e);
          lunarEnabled = false;
          lunarCourts = [];
        }

        const courtsSection = document.getElementById("courtsList");
        const infoCard = document.querySelector(".info-card");
        const summaryEl = document.getElementById("lunarSummary");

        // Global LUNAR-stilling (antal vundne kampe)
        // Global LUNAR-stilling (antal vundne kampe)
        const homeTotal = Number(adminState.lunarHomeWinsTotal ?? 0);
        const awayTotal = Number(adminState.lunarAwayWinsTotal ?? 0);
        updateTeamStanding(lunarEnabled, lunarCourts, homeTotal, awayTotal);

        const lunarResults = Array.isArray(adminState.lunarResults)
          ? adminState.lunarResults
          : [];

        // Hvor mange baner er med i LUNAR â†’ hvor mange kampe i runde 1+2?
        const baseMatches = lunarCourts.length * 2; // fx 3 baner â†’ 6 kampe

        // TÃ¦l hvor mange resultater vi har for runde 1+2 og for runde 7
        let r1r2Count = 0;
        let superCount = 0;

        lunarResults.forEach(m => {
          if (!m) return;
          const r = Number(m.round ?? 0);
          if (r === 1 || r === 2) {
            r1r2Count++;
          } else if (r === 7) {
            superCount++;
          }
        });

        // SlutskÃ¦rm vises KUN nÃ¥r:
        //  - LUNAR er aktiv + der er baner
        //  - alle kampe i runde 1+2 ER spillet (r1r2Count >= baseMatches)
        //  OG:
        //    - enten er stillingen IKKE lige (fx 4â€“2, 5â€“1, 6â€“0) â†’ afgÃ¸res pÃ¥ 6 kampe
        //    - eller ogsÃ¥ ER stillingen lige (fx 3â€“3), men der ER spillet mindst Ã©n 7. kamp (superCount >= 1)
let showSummary = false;

// Tving slutskÃ¦rm via URL ?summary=1 (krÃ¦ver mindst Ã©n kamp registreret)
if (forceSummary && lunarEnabled && r1r2Count + superCount > 0) {
  showSummary = true;
}
// Ellers normal logik
else if (
  lunarEnabled &&
  Array.isArray(lunarCourts) &&
  lunarCourts.length > 0 &&
  r1r2Count >= baseMatches
) {
  if (homeTotal !== awayTotal) {
    // Afgjort pÃ¥ runde 1+2 (fx 4â€“2)
    showSummary = true;
  } else if (homeTotal === awayTotal && superCount >= 1) {
    // StÃ¥r lige efter runde 1+2 (fx 3â€“3), men SUPER MATCH-TIE er spillet
    showSummary = true;
  }
}




        if (showSummary) {
          // Skjul banekort og info-tekst, vis slutskÃ¦rm
          if (courtsSection) courtsSection.classList.add("hidden");
          if (infoCard) infoCard.classList.add("hidden");
          if (summaryEl) {
            summaryEl.classList.remove("hidden");
            renderLunarSummary(lunarResults);
          }

          // Skjul ogsÃ¥ individuelle kort
          courts.forEach(court => {
            const cardEl = document.getElementById(`court-${court.id}`);
            if (cardEl) cardEl.style.display = "none";
          });

          return; // Ingen grund til at opdatere live-score
        } else {
          if (courtsSection) courtsSection.classList.remove("hidden");
          if (infoCard) infoCard.classList.remove("hidden");
          if (summaryEl) summaryEl.classList.add("hidden");
        }

        // Vis/skjul baner ift. LUNAR i normal visning
        courts.forEach(court => {
          const cardEl = document.getElementById(`court-${court.id}`);
          if (!cardEl) return;

          if (lunarEnabled && lunarCourts.length > 0) {
            cardEl.style.display = lunarCourts.includes(court.id) ? "" : "none";
          } else {
            cardEl.style.display = "";
          }
        });

        // Skal SUPER MATCH-TIE badge vÃ¦re aktiv?
        const superShouldBeVisible =
          lunarEnabled &&
          Array.isArray(lunarCourts) &&
          lunarCourts.length > 0 &&
          homeTotal === 3 &&
          awayTotal === 3;

        // Opdater hvert banekort (live)
        data.forEach(c => {
          const id = c.courtId;

          const statusEl     = document.getElementById(`status-${id}`);
          const homeName1El  = document.getElementById(`homeName1-${id}`);
          const homeName2El  = document.getElementById(`homeName2-${id}`);
          const awayName1El  = document.getElementById(`awayName1-${id}`);
          const awayName2El  = document.getElementById(`awayName2-${id}`);

          const homeSet1El   = document.getElementById(`homeSet1-${id}`);
          const homeSet2El   = document.getElementById(`homeSet2-${id}`);
          const awaySet1El   = document.getElementById(`awaySet1-${id}`);
          const awaySet2El   = document.getElementById(`awaySet2-${id}`);

          const homePointsEl = document.getElementById(`homePoints-${id}`);
          const awayPointsEl = document.getElementById(`awayPoints-${id}`);
          const homeGamesEl  = document.getElementById(`homeGames-${id}`);
          const awayGamesEl  = document.getElementById(`awayGames-${id}`);

          const updatedEl    = document.getElementById(`updated-${id}`);

          const teamHomeEl    = document.querySelector(`#court-${id} .team-home`);
          const teamAwayEl    = document.querySelector(`#court-${id} .team-away`);
          const setsSummaryEl = document.getElementById(`setsSummary-${id}`);
          const formatEl      = document.getElementById(`format-${id}`);

          const lunarBadgeEl = document.getElementById(`lunarBadge-${id}`);
          const superBadgeEl = document.getElementById(`superBadge-${id}`);

          if (!statusEl) return;

          const hasMatch      = c.hasMatch !== undefined ? c.hasMatch : true;
          const matchFinished = !!c.matchFinished;
          const winner        = typeof c.winner === "number" ? c.winner : 0;
          const mtb3rd        = !!c.mtb3rd;

          // --- init cache-strukturer ---
          if (!Object.prototype.hasOwnProperty.call(lastStates, id)) {
            lastStates[id] = null;
          }
          if (!Object.prototype.hasOwnProperty.call(lockedScore, id)) {
            lockedScore[id] = null;
          }

          const prev = lastStates[id];

          // Hvor mange sÃ¦t har kampen i alt (slut)?
          const totalSetsNow =
            Number(c.homeSets ?? 0) + Number(c.awaySets ?? 0);
          const endedInThreePlus =
            matchFinished && hasMatch && totalSetsNow >= 3;

          // Detekter "rigtig reset": ingen kamp og alt 0/tomt
          const isReset =
            !hasMatch &&
            Number(c.homeGames ?? 0) === 0 &&
            Number(c.awayGames ?? 0) === 0 &&
            Number(c.homeSets ?? 0) === 0 &&
            Number(c.awaySets ?? 0) === 0 &&
            (!c.setsStr || c.setsStr.trim() === "");

          if (isReset) {
            lockedScore[id] = null;
          }

          // Har kampen lige nu *skiftet* til "slut"?
          const justFinished =
            matchFinished &&
            hasMatch &&
            (!prev || !prev.matchFinished);

          // Kun lÃ¥s score i gul/blÃ¥, hvis kampen sluttede i 3. sÃ¦t
if (justFinished) {
  if (endedInThreePlus) {
    // Brug altid den AKTUELLE state (c), som indeholder 7â€“5 osv.
    const src = c;
    lockedScore[id] = {
      homePoints: src.homePoints,
      awayPoints: src.awayPoints,
      homePointsStr: src.homePointsStr,
      awayPointsStr: src.awayPointsStr,
      homeGames: src.homeGames,
      awayGames: src.awayGames,
    };
  } else {
    // Slut i 2 sÃ¦t â†’ ingen lÃ¥st score
    lockedScore[id] = null;
  }
}


          // Hvis kampen ikke lÃ¦ngere er slut (teoretisk) â†’ ryd lÃ¥s
          if (!matchFinished) {
            lockedScore[id] = null;
          }

          // --- LUNAR badges (som fÃ¸r) ---
          if (lunarBadgeEl) {
            if (c.isLunar) {
              lunarBadgeEl.classList.remove("hidden");

              if (c.isSuperMatchTie && superShouldBeVisible) {
                lunarBadgeEl.textContent = "LUNAR";
              } else if (c.lunarRoundUsed === 1 || c.lunarRoundUsed === 2) {
                lunarBadgeEl.textContent = `LUNAR R${c.lunarRoundUsed}`;
              } else {
                lunarBadgeEl.textContent = "LUNAR";
              }
            } else {
              lunarBadgeEl.classList.add("hidden");
            }
          }

          if (superBadgeEl) {
            if (c.isSuperMatchTie && superShouldBeVisible) {
              superBadgeEl.classList.remove("hidden");
            } else {
              superBadgeEl.classList.add("hidden");
            }
          }

          // Status-tekst
          if (!hasMatch) {
            statusEl.textContent = "Ingen kamp";
            statusEl.classList.remove("error");
          } else if (!c.online) {
            statusEl.textContent = "Ingen forbindelse";
            statusEl.classList.add("error");
          } else if (matchFinished) {
            statusEl.textContent = "Slut";
            statusEl.classList.remove("error");
          } else {
            statusEl.textContent = "I gang";
            statusEl.classList.remove("error");
          }

          // Navne -> split til spiller 1/2
          const homeRaw = c.homeName || "Hjemme";
          const awayRaw = c.awayName || "Ude";

          const homeParts = homeRaw.split("/").map(s => s.trim()).filter(Boolean);
          const awayParts = awayRaw.split("/").map(s => s.trim()).filter(Boolean);

          if (homeName1El) homeName1El.textContent = homeParts[0] || homeRaw || "Hjemme";
          if (homeName2El) homeName2El.textContent = homeParts[1] || "";

          if (awayName1El) awayName1El.textContent = awayParts[0] || awayRaw || "Ude";
          if (awayName2El) awayName2El.textContent = awayParts[1] || "";

          // SÃ¦t 1 og 2 (grÃ¥ bokse) â€“ uÃ¦ndret
          const set1 = buildSetStrings(c, 1);
          const set2 = buildSetStrings(c, 2);

          if (homeSet1El) homeSet1El.textContent = set1.home;
          if (awaySet1El) awaySet1El.textContent = set1.away;
          if (homeSet2El) homeSet2El.textContent = set2.home;
          if (awaySet2El) awaySet2El.textContent = set2.away;

          // Reset set-winner-klasser
          if (homeSet1El) homeSet1El.classList.remove("set-winner");
          if (awaySet1El) awaySet1El.classList.remove("set-winner");
          if (homeSet2El) homeSet2El.classList.remove("set-winner");
          if (awaySet2El) awaySet2El.classList.remove("set-winner");

          // Vinder i sÃ¦t 1
          const s1hVal = c.set1Home;
          const s1aVal = c.set1Away;
          if (typeof s1hVal === "number" &&
              typeof s1aVal === "number" &&
              s1hVal >= 0 &&
              s1aVal >= 0 &&
              s1hVal !== s1aVal) {
            if (s1hVal > s1aVal) {
              homeSet1El && homeSet1El.classList.add("set-winner");
            } else {
              awaySet1El && awaySet1El.classList.add("set-winner");
            }
          }

          // Vinder i sÃ¦t 2
          const s2hVal = c.set2Home;
          const s2aVal = c.set2Away;
          if (typeof s2hVal === "number" &&
              typeof s2aVal === "number" &&
              s2hVal >= 0 &&
              s2aVal >= 0 &&
              s2hVal !== s2aVal) {
            if (s2hVal > s2aVal) {
              homeSet2El && homeSet2El.classList.add("set-winner");
            } else {
              awaySet2El && awaySet2El.classList.add("set-winner");
            }
          }

          // Reset kamp-vinder highlight
          if (teamHomeEl) teamHomeEl.classList.remove("team-winner");
          if (teamAwayEl) teamAwayEl.classList.remove("team-winner");

          if (matchFinished && hasMatch) {
            if (winner === 1 && teamHomeEl) {
              teamHomeEl.classList.add("team-winner");
            } else if (winner === 2 && teamAwayEl) {
              teamAwayEl.classList.add("team-winner");
            }
          }

          // --- GUL (point) + BLÃ… (partier) ---

          if (matchFinished && !endedInThreePlus) {
            // Slut i 2 sÃ¦t â†’ gul/blÃ¥ ryger til "â€“"
            if (homePointsEl) homePointsEl.textContent = "â€“";
            if (awayPointsEl) awayPointsEl.textContent = "â€“";
            if (homeGamesEl)  homeGamesEl.textContent  = "â€“";
            if (awayGamesEl)  awayGamesEl.textContent  = "â€“";
          } else {
            // I gang ELLER slut i 3. sÃ¦t â†’ brug lÃ¥st score (hvis findes), ellers live
            const source = (matchFinished && endedInThreePlus && lockedScore[id])
              ? lockedScore[id]
              : {
                  homePoints: c.homePoints,
                  awayPoints: c.awayPoints,
                  homePointsStr: c.homePointsStr,
                  awayPointsStr: c.awayPointsStr,
                  homeGames: c.homeGames,
                  awayGames: c.awayGames,
                };

            if (homePointsEl) {
              const hpStr = source.homePointsStr ?? null;
              homePointsEl.textContent =
                hpStr !== null && hpStr !== undefined && hpStr !== ""
                  ? hpStr
                  : String(source.homePoints ?? "");
            }

            if (awayPointsEl) {
              const apStr = source.awayPointsStr ?? null;
              awayPointsEl.textContent =
                apStr !== null && apStr !== undefined && apStr !== ""
                  ? apStr
                  : String(source.awayPoints ?? "");
            }

            if (homeGamesEl) homeGamesEl.textContent = String(source.homeGames ?? 0);
            if (awayGamesEl) awayGamesEl.textContent = String(source.awayGames ?? 0);
          }

          // Samlet sÃ¦tresumÃ© (her kan 3. sÃ¦t/match-tiebreak ses)
          if (setsSummaryEl) {
            if (c.setsStr && c.setsStr.trim() !== "") {
              setsSummaryEl.textContent = "â€¢ " + c.setsStr;
            } else {
              setsSummaryEl.textContent = "";
            }
          }

          // 3. sÃ¦t-format
          if (formatEl) {
            if (mtb3rd) {
              formatEl.textContent = "â€¢ 3. sÃ¦t: match-tie (10)";
            } else {
              formatEl.textContent = "";
            }
          }

          // Tidsstempel
          if (updatedEl) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString("da-DK", {
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
            });
            updatedEl.textContent = timeStr;
          }

          // Til sidst: husk denne state til nÃ¦ste tick
          lastStates[id] = c;
        });


      } catch (err) {
        console.error("Fejl ved hentning af courts/adminState:", err);

        courts.forEach(court => {
          const statusEl = document.getElementById(`status-${court.id}`);
          if (statusEl) {
            statusEl.textContent = "Ingen forbindelse";
            statusEl.classList.add("error");
          }
        });

        const standingEl = document.getElementById("teamStanding");
        if (standingEl) standingEl.classList.add("hidden");

        const summaryEl = document.getElementById("lunarSummary");
        if (summaryEl) summaryEl.classList.add("hidden");
      }
    }

    // FÃ¸rste opdatering + interval
    updateAllCourts();
    setInterval(updateAllCourts, 1000);
  </script>
</body>
</html>
