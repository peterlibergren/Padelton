<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <title>Padel Scoreboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: system-ui, sans-serif;
      background: #020617;
      color: #e5e7eb;
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at top, #1d283a 0, #020617 55%);
    }

    header {
      text-align: center;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }

    h1 {
      margin: 0;
      font-size: clamp(1.8rem, 3vw, 2.4rem);
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    /* Stilling-linje under logoet */
    .team-standing {
      margin-top: 6px;
      font-size: clamp(1.4rem, 3.2vw, 2rem);
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .team-standing span {
      display: inline-block;
      min-width: 1.6em;
      text-align: center;
    }

    #standingHome {
      color: #22c55e;
      font-weight: 800;
    }

    #standingAway {
      color: #ef4444;
      font-weight: 800;
    }

    .team-standing-label {
      opacity: 0.8;
      margin-right: 4px;
    }

    .hidden {
      display: none !important;
    }

    main {
      flex: 1;
      padding: 10px;
      box-sizing: border-box;
    }

    .courts-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 900px;
      margin: 0 auto 16px;
    }

    .court-card {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 16px;
      padding: 10px 12px;
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.3);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .court-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .court-title {
      font-size: clamp(1rem, 2.1vw, 1.2rem);
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .court-status-tag {
      font-size: 0.7rem;
      text-transform: uppercase;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      white-space: nowrap;
    }

    .court-status-tag.error {
      border-color: #f97373;
      color: #fecaca;
    }

    /* Teams-blok */
    .teams {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .team {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .team-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      font-weight: 600;
    }

    .team-home .team-label {
      color: #22c55e;
    }

    .team-away .team-label {
      color: #ef4444;
    }

    /* Vindende hold highlight */
    .team-winner {
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.9);
      border-radius: 12px;
    }

    /* 5-kolonne layout: Navn | Sæt1 | Sæt2 | Point | Partier */
    .score-row {
      display: grid;
      grid-template-columns: minmax(0, 3fr) repeat(4, minmax(0, 1fr));
      gap: 4px;
      align-items: stretch;
      font-size: clamp(1.2rem, 3.2vw, 1.6rem);
    }

    .score-cell {
      padding: 6px 8px;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .score-cell-name {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      text-align: left;
      overflow: hidden;
    }

    .player-name,
    .player-sub {
      font-size: clamp(1rem, 2.2vw, 1.1rem);
      line-height: 1.2;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      color: #e5e7eb;
      text-align: left;
    }

    .player-sub {
      opacity: 0.9;
    }

    .score-set {
      font-weight: 600;
      background: rgba(15, 23, 42, 0.9);
    }

    .set-winner {
      background: rgba(75, 85, 99, 0.95);
      border-color: rgba(156, 163, 175, 0.95);
      color: #f9fafb;
    }

    .score-points {
      background: #facc15;
      color: #111827;
      font-weight: 700;
      font-size: 1.2em;
    }

    .score-games {
      font-weight: 700;
      background: rgba(30, 64, 175, 0.9);
      border-color: rgba(129, 140, 248, 0.8);
    }

    .court-footer {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      font-size: 0.72rem;
      color: #cbd5f5;
      opacity: 0.85;
      flex-wrap: wrap;
      gap: 4px;
      border-top: 1px dashed rgba(148, 163, 184, 0.4);
      padding-top: 4px;
      margin-top: 2px;
    }

    .sets-summary,
    .match-format {
      margin-left: 8px;
      opacity: 0.85;
      font-size: 0.7rem;
      white-space: nowrap;
    }

    .info-card {
      max-width: 900px;
      margin: 0 auto 24px;
      font-size: 0.8rem;
      color: #9ca3af;
      text-align: center;
      opacity: 0.85;
    }

    .lunar-badge,
    .super-badge {
      display: inline-block;
      margin-left: 6px;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .lunar-badge {
      background: rgba(56, 189, 248, 0.12);
      border: 1px solid rgba(56, 189, 248, 0.6);
      color: #e0f2fe;
    }

    .super-badge {
      background: rgba(234, 179, 8, 0.18);
      border: 1px solid rgba(234, 179, 8, 0.8);
      color: #fef9c3;
    }

    /* --- LUNAR SLUTSKÆRM --- */

    .lunar-summary {
      max-width: 900px;
      margin: 16px auto 24px;
      padding: 16px 14px 18px;
      border-radius: 18px;
      background: rgba(15, 23, 42, 0.97);
      border: 1px solid rgba(148, 163, 184, 0.7);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
    }

    .lunar-summary-title {
      margin: 0 0 10px;
      font-size: clamp(1.3rem, 2.8vw, 1.6rem);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      text-align: center;
    }

    .lunar-summary-subtitle {
      margin: 0 0 14px;
      font-size: 0.8rem;
      text-align: center;
      color: #9ca3af;
      opacity: 0.9;
    }

    .summary-section {
      margin-top: 12px;
    }

    .summary-round-title {
      margin: 0 0 6px;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #e5e7eb;
      opacity: 0.9;
    }

    .summary-match {
      margin-top: 6px;
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(75, 85, 99, 0.9);
    }

    .summary-match-header {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      opacity: 0.9;
      margin-bottom: 4px;
    }

    .summary-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
    }

    .summary-table th,
    .summary-table td {
      padding: 3px 4px;
      text-align: center;
    }

    .summary-table th:first-child,
    .summary-table td:first-child {
      text-align: left;
      width: 55%;
    }

    .summary-header-row th {
      font-weight: 600;
      opacity: 0.9;
      font-size: 0.76rem;
    }

    .summary-player-main {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .summary-player-sub {
      font-size: 0.74rem;
      opacity: 0.85;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>
<body>
  <header>
    <h1>PADELTON</h1>
    <div id="teamStanding" class="team-standing hidden">
      <span class="team-standing-label">Stilling:</span>
      <span id="standingHome">0</span>
      <span>-</span>
      <span id="standingAway">0</span>
    </div>
  </header>

  <main>
    <section class="courts-list" id="courtsList"></section>

    <!-- LUNAR slutskærm -->
    <section id="lunarSummary" class="lunar-summary hidden">
      <h2 class="lunar-summary-title">LUNAR – Slutresultat</h2>
      <p class="lunar-summary-subtitle">
        Resultater fra LUNAR runde 1, runde 2 og evt. 7. kamp.
      </p>
      <div id="lunarSummaryContent"></div>
    </section>

    <div class="info-card">
      Live scoreboard • Opdateres automatisk hvert sekund
    </div>
  </main>

  <script>
    const BASE_URL = "";

    const courts = [
      { id: 1, sponsor: "Bane 1 – BetaPack" },
      { id: 2, sponsor: "Bane 2 – Brdr. Thybo" },
      { id: 3, sponsor: "Bane 3 – Schantz" },
      { id: 4, sponsor: "Bane 4 – 10-4" },
      { id: 5, sponsor: "Bane 5 – Slagteren" },
    ];

    const list = document.getElementById("courtsList");

    // Opret kort DOM for hver bane
    courts.forEach(court => {
      const card = document.createElement("article");
      card.className = "court-card";
      card.id = `court-${court.id}`;

      card.innerHTML = `
        <div class="court-header">
          <div class="court-title">
            ${court.sponsor}
            <span class="lunar-badge hidden" id="lunarBadge-${court.id}">LUNAR</span>
            <span class="super-badge hidden" id="superBadge-${court.id}">SUPER MATCH-TIE</span>
          </div>
          <span class="court-status-tag" id="status-${court.id}">Opdaterer…</span>
        </div>

        <div class="teams">
          <!-- Hjemmehold -->
          <div class="team team-home">
            <div class="team-label">Hjemme</div>
            <div class="score-row">
              <div class="score-cell score-cell-name">
                <span class="player-name" id="homeName1-${court.id}">Hjemme 1</span>
                <span class="player-sub"  id="homeName2-${court.id}"></span>
              </div>
              <div class="score-cell score-set" id="homeSet1-${court.id}">–</div>
              <div class="score-cell score-set" id="homeSet2-${court.id}">–</div>
              <div class="score-cell score-points" id="homePoints-${court.id}">–</div>
              <div class="score-cell score-games"  id="homeGames-${court.id}">–</div>
            </div>
          </div>

          <!-- Udehold -->
          <div class="team team-away">
            <div class="team-label">Ude</div>
            <div class="score-row">
              <div class="score-cell score-cell-name">
                <span class="player-name" id="awayName1-${court.id}">Ude 1</span>
                <span class="player-sub"  id="awayName2-${court.id}"></span>
              </div>
              <div class="score-cell score-set" id="awaySet1-${court.id}">–</div>
              <div class="score-cell score-set" id="awaySet2-${court.id}">–</div>
              <div class="score-cell score-points" id="awayPoints-${court.id}">–</div>
              <div class="score-cell score-games"  id="awayGames-${court.id}">–</div>
            </div>
          </div>
        </div>

        <div class="court-footer">
          <span>Sidst opdateret: <span id="updated-${court.id}">–</span></span>
          <span class="sets-summary" id="setsSummary-${court.id}"></span>
          <span class="match-format" id="format-${court.id}"></span>
        </div>
      `;

      list.appendChild(card);
    });

    // Parser en samlet set-streng, fx "6-4,5-7,7-6(4)"
// og returnerer et array med op til 3 objekter:
// [{ home: "6", away: "4" }, { home: "5", away: "7" }, { home: "7", away: "6(4)" }]

    
    // Hjælper: byg sætscore-strenge (fx "7(4)" for taber i TB)
    function buildSetStrings(c, setIndex) {
      const homeKey = setIndex === 1 ? "set1Home" : "set2Home";
      const awayKey = setIndex === 1 ? "set1Away" : "set2Away";
      const tbKey   = setIndex === 1 ? "set1LoserTbPoints" : "set2LoserTbPoints";
      const lhKey   = setIndex === 1 ? "set1LoserIsHome"   : "set2LoserIsHome";

      const h = c[homeKey];
      const a = c[awayKey];

      if (h == null || a == null || h < 0 || a < 0) {
        return { home: "–", away: "–" };
      }

      const tb = c[tbKey];
      const lIsHome = !!c[lhKey];

      if (tb == null || tb < 0) {
        return { home: String(h), away: String(a) };
      }

      if (lIsHome) {
        return { home: `${h}(${tb})`, away: String(a) };
      } else {
        return { home: String(h), away: `${a}(${tb})` };
      }
    }
// NY: samme logik, men til objekterne i lunarResults (slutskærm)
function buildSetStringsFromResult(m, setIndex) {
  const homeKey = setIndex === 1 ? "set1Home" : "set2Home";
  const awayKey = setIndex === 1 ? "set1Away" : "set2Away";
  const tbKey   = setIndex === 1 ? "set1LoserTbPoints" : "set2LoserTbPoints";
  const lhKey   = setIndex === 1 ? "set1LoserIsHome"   : "set2LoserIsHome";

  const h = m[homeKey];
  const a = m[awayKey];

  if (h == null || a == null || h < 0 || a < 0) {
    return { home: "", away: "" };
  }

  const tb = m[tbKey];
  const lIsHome = !!m[lhKey];

  if (tb == null || tb < 0) {
    return { home: String(h), away: String(a) };
  }

  if (lIsHome) {
    return { home: `${h}(${tb})`, away: String(a) };
  } else {
    return { home: String(h), away: `${a}(${tb})` };
  }
}

    // LUNAR-stilling øverst – bruger globale totals fra adminState
    function updateTeamStanding(lunarEnabled, lunarCourts, lunarHomeTotal, lunarAwayTotal) {
      const standingEl = document.getElementById("teamStanding");
      const homeSpan = document.getElementById("standingHome");
      const awaySpan = document.getElementById("standingAway");

      if (!standingEl || !homeSpan || !awaySpan) return;

      const active =
        !!lunarEnabled &&
        Array.isArray(lunarCourts) &&
        lunarCourts.length > 0;

      if (!active) {
        standingEl.classList.add("hidden");
        homeSpan.textContent = "0";
        awaySpan.textContent = "0";
        return;
      }

      const h = Number.isFinite(Number(lunarHomeTotal)) ? Number(lunarHomeTotal) : 0;
      const a = Number.isFinite(Number(lunarAwayTotal)) ? Number(lunarAwayTotal) : 0;

      homeSpan.textContent = String(h);
      awaySpan.textContent = String(a);
      standingEl.classList.remove("hidden");
    }

    // Pars setsStr → [{home, away}, ...]
  // Parser en samlet set-streng, fx "6-4,5-7,7-6(4)"
// og returnerer et array med op til 3 objekter:
// [{ home: "6", away: "4" }, { home: "5", away: "7" }, { home: "7", away: "6(4)" }]
function parseSetsStr(setsStr) {
  if (!setsStr || typeof setsStr !== "string") return [];

  return setsStr
    .split(",")
    .map(s => s.trim())
    .filter(Boolean)
    .map(part => {
      const [homeRaw, awayRaw] = part.split("-").map(x => (x || "").trim());
      return {
        home: homeRaw || "",
        away: awayRaw || "",
      };
    })
    .slice(0, 3); // max 3 sæt
}

function renderLunarSummary(lunarResults) {
  const container = document.getElementById("lunarSummaryContent");
  if (!container) return;

  container.innerHTML = "";

  if (!Array.isArray(lunarResults) || lunarResults.length === 0) {
    container.textContent = "Ingen LUNAR-resultater.";
    return;
  }

  // Sorter efter runde (1,2,7) og bane
  const sorted = [...lunarResults].sort((a, b) => {
    const ra = Number(a.round ?? 0);
    const rb = Number(b.round ?? 0);
    if (ra !== rb) return ra - rb;
    const ca = Number(a.courtId ?? 0);
    const cb = Number(b.courtId ?? 0);
    return ca - cb;
  });

  // Del op i runder
  const groups = { 1: [], 2: [], 7: [] };
  sorted.forEach(m => {
    const r = Number(m.round);
    if (r === 1 || r === 2 || r === 7) {
      groups[r].push(m);
    }
  });

  [1, 2, 7].forEach(r => {
    const list = groups[r];
    if (!list || list.length === 0) return;

    const section = document.createElement("section");
    section.className = "summary-section";

    const h = document.createElement("h3");
    h.className = "summary-round-title";
    if (r === 1) h.textContent = "Lunar runde 1";
    else if (r === 2) h.textContent = "Lunar runde 2";
    else h.textContent = "7. kamp – SUPER MATCH-TIE";
    section.appendChild(h);

    list.forEach(m => {
      const card = document.createElement("div");
      card.className = "summary-match";

      // Header: Bane X
      const header = document.createElement("div");
      header.className = "summary-match-header";
      header.textContent = `Bane ${m.courtId ?? "?"}`;
      card.appendChild(header);

      // Parse sætcifre fra setsStr (fx "6-4,5-7,7-6(4)")
      const setsParsed = parseSetsStr(m.setsStr || "");
      const homeVals = ["", "", ""];
      const awayVals = ["", "", ""];

      for (let i = 0; i < 3; i++) {
        if (setsParsed[i]) {
          homeVals[i] = setsParsed[i].home ?? "";
          awayVals[i] = setsParsed[i].away ?? "";
        }
      }

      // Split spillernavne i to linjer pr. hold (x / y)
      const homeName = m.homeName || "Hjemme";
      const awayName = m.awayName || "Ude";

      const homeParts = homeName.split("/").map(s => s.trim()).filter(Boolean);
      const awayParts = awayName.split("/").map(s => s.trim()).filter(Boolean);

      const homeMain = homeParts[0] || homeName;
      const homeSub  = homeParts[1] || "";
      const awayMain = awayParts[0] || awayName;
      const awaySub  = awayParts[1] || "";

      // Byg tabel: tom | 1. sæt | 2. sæt | 3. sæt
      const table = document.createElement("table");
      table.className = "summary-table";

      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      headerRow.className = "summary-header-row";

      const thEmpty = document.createElement("th");
      thEmpty.textContent = "";
      headerRow.appendChild(thEmpty);

      const th1 = document.createElement("th");
      th1.textContent = "1. sæt";
      headerRow.appendChild(th1);

      const th2 = document.createElement("th");
      th2.textContent = "2. sæt";
      headerRow.appendChild(th2);

      const th3 = document.createElement("th");
      th3.textContent = "3. sæt";
      headerRow.appendChild(th3);

      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      // Hjemme spiller x – med scores
      const trHome1 = document.createElement("tr");
      const tdHomeMain = document.createElement("td");
      const homeMainSpan = document.createElement("div");
      homeMainSpan.className = "summary-player-main";
      homeMainSpan.textContent = homeMain;
      tdHomeMain.appendChild(homeMainSpan);
      trHome1.appendChild(tdHomeMain);

      const tdH1 = document.createElement("td");
      tdH1.textContent = homeVals[0] || "";
      trHome1.appendChild(tdH1);

      const tdH2 = document.createElement("td");
      tdH2.textContent = homeVals[1] || "";
      trHome1.appendChild(tdH2);

      const tdH3 = document.createElement("td");
      tdH3.textContent = homeVals[2] || "";
      trHome1.appendChild(tdH3);

      tbody.appendChild(trHome1);

      // Hjemme spiller y – kun navn
      if (homeSub) {
        const trHome2 = document.createElement("tr");
        const tdHomeSub = document.createElement("td");
        const homeSubSpan = document.createElement("div");
        homeSubSpan.className = "summary-player-sub";
        homeSubSpan.textContent = homeSub;
        tdHomeSub.appendChild(homeSubSpan);
        trHome2.appendChild(tdHomeSub);

        trHome2.appendChild(document.createElement("td"));
        trHome2.appendChild(document.createElement("td"));
        trHome2.appendChild(document.createElement("td"));

        tbody.appendChild(trHome2);
      }

      // Ude spiller x – med scores
      const trAway1 = document.createElement("tr");
      const tdAwayMain = document.createElement("td");
      const awayMainSpan = document.createElement("div");
      awayMainSpan.className = "summary-player-main";
      awayMainSpan.textContent = awayMain;
      tdAwayMain.appendChild(awayMainSpan);
      trAway1.appendChild(tdAwayMain);

      const tdA1 = document.createElement("td");
      tdA1.textContent = awayVals[0] || "";
      trAway1.appendChild(tdA1);

      const tdA2 = document.createElement("td");
      tdA2.textContent = awayVals[1] || "";
      trAway1.appendChild(tdA2);

      const tdA3 = document.createElement("td");
      tdA3.textContent = awayVals[2] || "";
      trAway1.appendChild(tdA3);

      tbody.appendChild(trAway1);

      // Ude spiller y – kun navn
      if (awaySub) {
        const trAway2 = document.createElement("tr");
        const tdAwaySub = document.createElement("td");
        const awaySubSpan = document.createElement("div");
        awaySubSpan.className = "summary-player-sub";
        awaySubSpan.textContent = awaySub;
        tdAwaySub.appendChild(awaySubSpan);
        trAway2.appendChild(tdAwaySub);

        trAway2.appendChild(document.createElement("td"));
        trAway2.appendChild(document.createElement("td"));
        trAway2.appendChild(document.createElement("td"));

        tbody.appendChild(trAway2);
      }

      table.appendChild(tbody);
      card.appendChild(table);
      section.appendChild(card);
    });

    container.appendChild(section);
  });
}


    // Hent adminState + ALLE baner og opdater UI
    async function updateAllCourts() {
      try {
        const [adminResp, courtsResp] = await Promise.all([
          fetch(BASE_URL + "/api/adminState", { cache: "no-store" }),
          fetch(BASE_URL + "/api/courts", { cache: "no-store" }),
        ]);

        if (!adminResp.ok) throw new Error("HTTP adminState " + adminResp.status);
        if (!courtsResp.ok) throw new Error("HTTP courts " + courtsResp.status);

        const adminState = await adminResp.json();
        const data = await courtsResp.json();

        let lunarEnabled = false;
        let lunarCourts = [];

        try {
          lunarEnabled = !!adminState.lunarEnabled;
          lunarCourts = Array.isArray(adminState.lunarCourts)
            ? adminState.lunarCourts.map(Number).filter(n => Number.isFinite(n))
            : [];
        } catch (e) {
          console.warn("Kunne ikke læse LUNAR-felter fra adminState:", e);
          lunarEnabled = false;
          lunarCourts = [];
        }

        const courtsSection = document.getElementById("courtsList");
        const infoCard = document.querySelector(".info-card");
        const summaryEl = document.getElementById("lunarSummary");

        // Global LUNAR-stilling (antal vundne kampe)
        const homeTotal = Number(adminState.lunarHomeWinsTotal ?? 0);
        const awayTotal = Number(adminState.lunarAwayWinsTotal ?? 0);
        updateTeamStanding(lunarEnabled, lunarCourts, homeTotal, awayTotal);

        const lunarResults = Array.isArray(adminState.lunarResults)
          ? adminState.lunarResults
          : [];

        // Slutskærm når LUNAR aktiv + mindst 1 bane + min. 6 vundne kampe i alt
        const finishedCount = homeTotal + awayTotal;
        const showSummary =
          lunarEnabled &&
          Array.isArray(lunarCourts) &&
          lunarCourts.length > 0 &&
          finishedCount >= 6;

        if (showSummary) {
          // Skjul banekort og info-tekst, vis slutskærm
          if (courtsSection) courtsSection.classList.add("hidden");
          if (infoCard) infoCard.classList.add("hidden");
          if (summaryEl) {
            summaryEl.classList.remove("hidden");
            renderLunarSummary(lunarResults);
          }

          // Skjul også individuelle kort
          courts.forEach(court => {
            const cardEl = document.getElementById(`court-${court.id}`);
            if (cardEl) cardEl.style.display = "none";
          });

          return; // Ingen grund til at opdatere live-score
        } else {
          if (courtsSection) courtsSection.classList.remove("hidden");
          if (infoCard) infoCard.classList.remove("hidden");
          if (summaryEl) summaryEl.classList.add("hidden");
        }

        // Vis/skjul baner ift. LUNAR i normal visning
        courts.forEach(court => {
          const cardEl = document.getElementById(`court-${court.id}`);
          if (!cardEl) return;

          if (lunarEnabled && lunarCourts.length > 0) {
            cardEl.style.display = lunarCourts.includes(court.id) ? "" : "none";
          } else {
            cardEl.style.display = "";
          }
        });

        // Skal SUPER MATCH-TIE badge være aktiv?
        const superShouldBeVisible =
          lunarEnabled &&
          Array.isArray(lunarCourts) &&
          lunarCourts.length > 0 &&
          homeTotal === 3 &&
          awayTotal === 3;

        // Opdater hvert banekort (live)
        data.forEach(c => {
          const id = c.courtId;

          const statusEl     = document.getElementById(`status-${id}`);
          const homeName1El  = document.getElementById(`homeName1-${id}`);
          const homeName2El  = document.getElementById(`homeName2-${id}`);
          const awayName1El  = document.getElementById(`awayName1-${id}`);
          const awayName2El  = document.getElementById(`awayName2-${id}`);

          const homeSet1El   = document.getElementById(`homeSet1-${id}`);
          const homeSet2El   = document.getElementById(`homeSet2-${id}`);
          const awaySet1El   = document.getElementById(`awaySet1-${id}`);
          const awaySet2El   = document.getElementById(`awaySet2-${id}`);

          const homePointsEl = document.getElementById(`homePoints-${id}`);
          const awayPointsEl = document.getElementById(`awayPoints-${id}`);
          const homeGamesEl  = document.getElementById(`homeGames-${id}`);
          const awayGamesEl  = document.getElementById(`awayGames-${id}`);

          const updatedEl    = document.getElementById(`updated-${id}`);

          const teamHomeEl    = document.querySelector(`#court-${id} .team-home`);
          const teamAwayEl    = document.querySelector(`#court-${id} .team-away`);
          const setsSummaryEl = document.getElementById(`setsSummary-${id}`);
          const formatEl      = document.getElementById(`format-${id}`);

          const lunarBadgeEl = document.getElementById(`lunarBadge-${id}`);
          const superBadgeEl = document.getElementById(`superBadge-${id}`);

          if (!statusEl) return;

          // LUNAR badges
          if (lunarBadgeEl) {
            if (c.isLunar) {
              lunarBadgeEl.classList.remove("hidden");

              if (c.isSuperMatchTie && superShouldBeVisible) {
                lunarBadgeEl.textContent = "LUNAR";
              } else if (c.lunarRoundUsed === 1 || c.lunarRoundUsed === 2) {
                lunarBadgeEl.textContent = `LUNAR R${c.lunarRoundUsed}`;
              } else {
                lunarBadgeEl.textContent = "LUNAR";
              }
            } else {
              lunarBadgeEl.classList.add("hidden");
            }
          }

          if (superBadgeEl) {
            if (c.isSuperMatchTie && superShouldBeVisible) {
              superBadgeEl.classList.remove("hidden");
            } else {
              superBadgeEl.classList.add("hidden");
            }
          }

          const hasMatch = c.hasMatch !== undefined ? c.hasMatch : true;
          const matchFinished = !!c.matchFinished;
          const winner = typeof c.winner === "number" ? c.winner : 0;
          const mtb3rd = !!c.mtb3rd;

          if (!hasMatch) {
            statusEl.textContent = "Ingen kamp";
            statusEl.classList.remove("error");
          } else if (!c.online) {
            statusEl.textContent = "Ingen forbindelse";
            statusEl.classList.add("error");
          } else if (matchFinished) {
            statusEl.textContent = "Slut";
            statusEl.classList.remove("error");
          } else {
            statusEl.textContent = "I gang";
            statusEl.classList.remove("error");
          }

          // Navne -> split til spiller 1/2
          const homeRaw = c.homeName || "Hjemme";
          const awayRaw = c.awayName || "Ude";

          const homeParts = homeRaw.split("/").map(s => s.trim()).filter(Boolean);
          const awayParts = awayRaw.split("/").map(s => s.trim()).filter(Boolean);

          if (homeName1El) homeName1El.textContent = homeParts[0] || homeRaw || "Hjemme";
          if (homeName2El) homeName2El.textContent = homeParts[1] || "";

          if (awayName1El) awayName1El.textContent = awayParts[0] || awayRaw || "Ude";
          if (awayName2El) awayName2El.textContent = awayParts[1] || "";

          // Sæt 1 og 2
          const set1 = buildSetStrings(c, 1);
          const set2 = buildSetStrings(c, 2);

          if (homeSet1El) homeSet1El.textContent = set1.home;
          if (awaySet1El) awaySet1El.textContent = set1.away;
          if (homeSet2El) homeSet2El.textContent = set2.home;
          if (awaySet2El) awaySet2El.textContent = set2.away;

          // Reset set-winner-klasser
          if (homeSet1El) homeSet1El.classList.remove("set-winner");
          if (awaySet1El) awaySet1El.classList.remove("set-winner");
          if (homeSet2El) homeSet2El.classList.remove("set-winner");
          if (awaySet2El) awaySet2El.classList.remove("set-winner");

          // Vinder i sæt 1
          const s1hVal = c.set1Home;
          const s1aVal = c.set1Away;
          if (typeof s1hVal === "number" &&
              typeof s1aVal === "number" &&
              s1hVal >= 0 &&
              s1aVal >= 0 &&
              s1hVal !== s1aVal) {
            if (s1hVal > s1aVal) {
              homeSet1El && homeSet1El.classList.add("set-winner");
            } else {
              awaySet1El && awaySet1El.classList.add("set-winner");
            }
          }

          // Vinder i sæt 2
          const s2hVal = c.set2Home;
          const s2aVal = c.set2Away;
          if (typeof s2hVal === "number" &&
              typeof s2aVal === "number" &&
              s2hVal >= 0 &&
              s2aVal >= 0 &&
              s2hVal !== s2aVal) {
            if (s2hVal > s2aVal) {
              homeSet2El && homeSet2El.classList.add("set-winner");
            } else {
              awaySet2El && awaySet2El.classList.add("set-winner");
            }
          }

          // Reset kamp-vinder highlight
          if (teamHomeEl) teamHomeEl.classList.remove("team-winner");
          if (teamAwayEl) teamAwayEl.classList.remove("team-winner");

          if (matchFinished && hasMatch) {
            if (winner === 1 && teamHomeEl) {
              teamHomeEl.classList.add("team-winner");
            } else if (winner === 2 && teamAwayEl) {
              teamAwayEl.classList.add("team-winner");
            }
          }

          // Point
          if (homePointsEl) {
            const hpStr = c.homePointsStr ?? null;
            homePointsEl.textContent = (hpStr !== null && hpStr !== undefined)
              ? hpStr
              : String(c.homePoints ?? "");
          }

          if (awayPointsEl) {
            const apStr = c.awayPointsStr ?? null;
            awayPointsEl.textContent = (apStr !== null && apStr !== undefined)
              ? apStr
              : String(c.awayPoints ?? "");
          }

          // Partier
          if (homeGamesEl) homeGamesEl.textContent = String(c.homeGames ?? 0);
          if (awayGamesEl) awayGamesEl.textContent = String(c.awayGames ?? 0);

          // Samlet sætresumé
          if (setsSummaryEl) {
            if (c.setsStr && c.setsStr.trim() !== "") {
              setsSummaryEl.textContent = "• " + c.setsStr;
            } else {
              setsSummaryEl.textContent = "";
            }
          }

          // 3. sæt-format
          if (formatEl) {
            if (mtb3rd) {
              formatEl.textContent = "• 3. sæt: match-tie (10)";
            } else {
              formatEl.textContent = "";
            }
          }

          // Tidsstempel
          if (updatedEl) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString("da-DK", {
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
            });
            updatedEl.textContent = timeStr;
          }
        });

      } catch (err) {
        console.error("Fejl ved hentning af courts/adminState:", err);

        courts.forEach(court => {
          const statusEl = document.getElementById(`status-${court.id}`);
          if (statusEl) {
            statusEl.textContent = "Ingen forbindelse";
            statusEl.classList.add("error");
          }
        });

        const standingEl = document.getElementById("teamStanding");
        if (standingEl) standingEl.classList.add("hidden");

        const summaryEl = document.getElementById("lunarSummary");
        if (summaryEl) summaryEl.classList.add("hidden");
      }
    }

    // Første opdatering + interval
    updateAllCourts();
    setInterval(updateAllCourts, 1000);
  </script>
</body>
</html>
