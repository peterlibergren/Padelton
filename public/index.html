<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <title>Padel Scoreboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: system-ui, sans-serif;
      background: #020617;
      color: #e5e7eb;
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      text-align: center;
      padding: 6px;
    }

    h1 {
      margin: 0;
      font-size: clamp(1.8rem, 3vw, 2.6rem);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .hall-layout {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 8px;
      padding: 6px;
      box-sizing: border-box;
      overflow: hidden;
    }

    /* Placering i hallen */
    #court-2 { grid-row: 1; grid-column: 1; }
    #court-3 { grid-row: 1; grid-column: 2; }
    #court-1 { grid-row: 2; grid-column: 1; }
    #court-4 { grid-row: 2; grid-column: 2; }
    #lounge  { grid-row: 3; grid-column: 1; }
    #court-5 { grid-row: 3; grid-column: 2; }

    /* Opholdsområde */
    .lounge-card {
      background: radial-gradient(circle at top left, #22c55e 0, #020617 50%);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .court-card {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    /* 20×10 m → 2:1, vandret */
    .court-surface {
      position: relative;
      aspect-ratio: 2 / 1;
      width: 80%;
      max-height: 80%;
      background: #1b3a7a;
      border-radius: 12px;
      border: 4px solid #ffffff;
      box-shadow: 0 18px 30px rgba(0, 0, 0, 0.6);
      box-sizing: border-box;
      overflow: hidden;
    }

    /* Indre bane-ramme */
    .court-lines {
      position: absolute;
      inset: 12% 8%;
      border: 2px solid #ffffff;
      box-sizing: border-box;
    }

    .line {
      position: absolute;
      background: #ffffff;
    }

    /* Net – lodret linje midt på banen */
    .line-net {
      top: 0;
      bottom: 0;
      left: 50%;
      width: 3px;
      transform: translateX(-50%);
      background: #ffffff;
    }

    /* Servelinjer – lodrette, 3,05 m fra hver bagvæg (≈15,25%) */
    .line-service {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #ffffff;
    }

    .service-left {
      left: 15.25%;
    }

    .service-right {
      left: 84.75%;
    }

    /* Center-servicelinjer – vandrette stykker mellem servelinje og net */
    .line-center {
      position: absolute;
      height: 2px;
      background: #ffffff;
      top: 50%;
      transform: translateY(-50%);
    }

    /* Fra venstre servelinje til net */
    .center-left {
      left: 15.25%;
      width: 34.75%;   /* 50 - 15.25 */
    }

    /* Fra net til højre servelinje */
    .center-right {
      left: 50%;
      width: 34.75%;   /* 84.75 - 50 */
    }

    /* Info på banen */
    .court-name-tag {
      position: absolute;
      top: 6px;
      left: 10px;
      right: 10px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      display: flex;
      justify-content: space-between;
      color: #e5e7eb;
    }

    .court-status-tag {
      font-size: 0.7rem;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
    }

    .court-status-tag.error {
      border-color: #f97373;
      color: #fecaca;
    }

    .court-center-score {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .score-points {
      font-size: clamp(2.2rem, 3vw, 3.4rem);
      font-weight: 700;
      line-height: 1;
    }

    .score-divider {
      margin: 0 0.3em;
    }

    .score-subline {
      margin-top: 6px;
      font-size: 0.85rem;
      color: #e5e7eb;
      opacity: 0.9;
    }

    .court-footer-time {
      position: absolute;
      bottom: 6px;
      right: 10px;
      font-size: 0.7rem;
      color: #cbd5f5;
    }
  </style>
</head>
<body>
  <header>
    <h1>PADELTON</h1>
  </header>

  <main class="hall-layout" id="courtsGrid">
    <!-- Opholdsområde -->
    <article class="lounge-card" id="lounge">
      <div>OPHOLDSOMRÅDE</div>
      <div style="font-size:0.8rem; margin-top:4px;">Pause • Tilskuere • Hygge</div>
    </article>
  </main>

  <script>
    // Controller-ESP32 IP
    const CONTROLLER_URL = "";

    // Baner til layout (ingen direkte IP mere)
    const courts = [
      { id: 2, name: "Bane 2 – Brdr. Thybo" },
      { id: 3, name: "Bane 3 – Schantz" },
      { id: 1, name: "Bane 1 – BetaPack" },
      { id: 4, name: "Bane 4 – 10-4" },
      { id: 5, name: "Bane 5 – Slagteren" },
    ];

    const grid = document.getElementById("courtsGrid");

    // Opret kort DOM for hver bane
    courts.forEach(court => {
      const card = document.createElement("article");
      card.className = "court-card";
      card.id = `court-${court.id}`;

      card.innerHTML = `
        <div class="court-surface">
          <div class="court-lines">
            <div class="line line-service service-left"></div>
            <div class="line line-service service-right"></div>
            <div class="line line-net"></div>
            <div class="line line-center center-left"></div>
            <div class="line line-center center-right"></div>
          </div>

          <div class="court-name-tag">
            <span>${court.name}</span>
            <span class="court-status-tag" id="status-${court.id}">Opdaterer…</span>
          </div>

          <div class="court-center-score">
            <div class="score-points">
              <span id="homePoints-${court.id}">–</span>
              <span class="score-divider">:</span>
              <span id="awayPoints-${court.id}">–</span>
            </div>
            <div class="score-subline">
              Partier:
              <span id="games-${court.id}">– : –</span><br />
              Sæt:
              <span id="sets-${court.id}">– : –</span>
            </div>
          </div>

          <div class="court-footer-time">
            Sidst opdateret: <span id="updated-${court.id}">–</span>
          </div>
        </div>
      `;

      grid.appendChild(card);
    });

    // Hent ALLE baner fra controlleren og opdater UI
    async function updateAllCourts() {
      try {
        const response = await fetch(CONTROLLER_URL + "/api/courts", { cache: "no-store" });

        if (!response.ok) {
          throw new Error("HTTP " + response.status);
        }

        const data = await response.json(); // array med court-objekter

        data.forEach(c => {
          const id = c.courtId;
          const statusEl = document.getElementById(`status-${id}`);
          if (!statusEl) return; // hvis banen ikke er på layoutet

          // Online/offline
          statusEl.textContent = c.online ? "Online" : "Offline";
          if (c.online) {
            statusEl.classList.remove("error");
          } else {
            statusEl.classList.add("error");
          }

          // Score
          const homePointsEl = document.getElementById(`homePoints-${id}`);
          const awayPointsEl = document.getElementById(`awayPoints-${id}`);
          const gamesEl      = document.getElementById(`games-${id}`);
          const setsEl       = document.getElementById(`sets-${id}`);
          const updatedEl    = document.getElementById(`updated-${id}`);

          // Brug tekst-versionen af points (0/15/30/40/AD eller tiebreak-tal),
          // som kommer direkte fra bane-ESP'ens logik via controlleren
          if (homePointsEl) {
            const hpStr = c.homePointsStr ?? null;
            homePointsEl.textContent = (hpStr !== null && hpStr !== undefined)
              ? hpStr
              : String(c.homePoints ?? "");
          }

          if (awayPointsEl) {
            const apStr = c.awayPointsStr ?? null;
            awayPointsEl.textContent = (apStr !== null && apStr !== undefined)
              ? apStr
              : String(c.awayPoints ?? "");
          }

          if (gamesEl) {
            gamesEl.textContent = `${c.homeGames ?? 0} : ${c.awayGames ?? 0}`;
          }

          if (setsEl) {
            setsEl.textContent = `${c.homeSets ?? 0} : ${c.awaySets ?? 0}`;
          }

          if (updatedEl) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString("da-DK", {
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit",
            });
            updatedEl.textContent = timeStr;
          }
        });
      } catch (err) {
        console.error("Fejl ved hentning af courts:", err);
        // Hvis controller ikke svarer, markér alle som offline
        courts.forEach(court => {
          const statusEl = document.getElementById(`status-${court.id}`);
          if (statusEl) {
            statusEl.textContent = "Offline";
            statusEl.classList.add("error");
          }
        });
      }
    }

    // Første opdatering + interval
    updateAllCourts();
    setInterval(updateAllCourts, 1000);
  </script>
</body>
</html>
